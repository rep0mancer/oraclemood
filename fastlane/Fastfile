default_platform(:ios)

app_config_path = File.expand_path("../OracleLightShared/Configuration/AppConfig.swift", __dir__)
app_config = File.read(app_config_path)
bundle_identifier = app_config[/bundleIdentifier\s*=\s*"([^"]+)"/, 1]
contact_email = app_config[/contactEmail\s*=\s*"([^"]+)"/, 1]

platform :ios do
  desc "Build and upload a beta build to TestFlight"
  lane :beta do
    increment_build_number(xcodeproj: "OracleLight.xcodeproj")
    build_app(
      scheme: "OracleLightApp",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          bundle_identifier => "match AppStore #{bundle_identifier}"
        }
      }
    )
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      beta_app_review_info: {
        contact_email: contact_email,
        contact_first_name: "Oracle",
        contact_last_name: "Light",
        contact_phone: "+1 555 123 4567",
        demo_account_name: "",
        demo_account_password: "",
        notes: "Automated TestFlight build"
      }
    )
  end

  desc "Build and upload a release build to TestFlight (external)"
  lane :release do
    capture_screenshots
    beta
  end
end